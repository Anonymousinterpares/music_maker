<!DOCTYPE html>
<html>
<head>
    <style>
        :root {
            --bg-color: #121212; --panel-color: #1e1e1e; --accent: #00ff99; --text: #eee; --record: #ff4444;
        }
        body { background: var(--bg-color); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; user-select: none; }
        
        header { display: flex; align-items: center; justify-content: space-between; padding: 5px 15px; background: #000; border-bottom: 1px solid #333; height: 40px; }
        .transport-controls { display: flex; gap: 8px; align-items: center; }
        .btn { background: #333; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 0.7em; font-weight: bold; }
        .btn.active { background: var(--accent); color: black; }
        .btn.recording { background: var(--record); color: white; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .main-layout { display: flex; flex-direction: column; height: 100vh; }
        
        .piano-roll-container { flex-grow: 1; position: relative; background: #111; overflow: hidden; cursor: crosshair; }
        canvas { width: 100%; height: 100%; }

        .bottom-panel { background: var(--panel-color); padding: 10px; display: flex; gap: 20px; align-items: center; border-top: 1px solid #333; }
        .knob-group { display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 0.6em; color: #888; }
        
        .keyboard-area { height: 100px; display: flex; justify-content: center; background: #000; position: relative; }
        .keyboard { display: flex; position: relative; height: 90px; }
        .key { width: 24px; height: 80px; border: 1px solid #444; background: #ddd; position: relative; transition: background 0.1s; }
        .key.black { background: #222; width: 16px; height: 50px; margin-left: -8px; margin-right: -8px; z-index: 2; border-color: #000; }
        .key.active { background: var(--accent) !important; }
        .key::after { content: attr(data-key); position: absolute; bottom: 2px; width: 100%; text-align: center; font-size: 8px; color: #666; pointer-events: none; }
        .key.waiting { background: #ffaa00 !important; }

        #assign-hint { position: absolute; top: -20px; font-size: 10px; color: #ffaa00; display: none; }
        #status { font-size: 10px; color: #555; position: absolute; bottom: 5px; right: 10px; }
    </style>
</head>
<body>
    <div class="main-layout">
        <header>
            <div style="color: var(--accent); font-weight: bold; font-size: 0.8em;">MUSIC MAKER v0.2</div>
            <div class="transport-controls">
                <button id="play-btn" class="btn" onclick="cmd('play')">PLAY</button>
                <button id="stop-btn" class="btn" onclick="cmd('stop')">STOP</button>
                <button id="rec-btn" class="btn" onclick="toggleRec()">REC</button>
                <button id="metro-btn" class="btn" onclick="toggleMetro()">METRO</button>
                <input type="number" id="bpm" value="120" class="btn" style="width: 40px;" onchange="cmd('bpm', this.value)">
                <button class="btn" onclick="cmd('clear')">CLEAR</button>
                <button class="btn" onclick="cmd('save')" style="background: #444;">SAVE AS...</button>
                <button id="assign-btn" class="btn" onclick="toggleAssignMode()" style="background: #555;">ASSIGN KEYS</button>
            </div>
            <div id="clock" style="font-family: monospace; font-size: 0.8em; color: var(--accent);">1.1.00</div>
        </header>

        <div class="piano-roll-container" id="pr-container">
            <canvas id="pr-canvas"></canvas>
        </div>

        <div class="bottom-panel">
            <div class="knob-group">
                <span>OSC</span>
                <select id="osc" onchange="updateParams()" style="background:#000; color:var(--accent); border:1px solid #444; font-size: 10px;">
                    <option value="0">Sine</option><option value="1" selected>Saw</option><option value="2">Square</option><option value="3">Tri</option>
                </select>
            </div>
            <div class="knob-group">
                <span>CUTOFF</span>
                <input type="range" id="cutoff" min="20" max="15000" value="2000" oninput="updateParams()">
            </div>
            <div class="knob-group"><span>RES</span><input type="range" id="res" min="0.1" max="15" step="0.1" value="0.7" oninput="updateParams()"></div>
            <div class="keyboard-area">
                <div id="assign-hint">CLICK A PIANO KEY THEN PRESS A COMPUTER KEY</div>
                <div class="keyboard" id="kb"></div>
            </div>
        </div>
        <div id="status">BRIDGE: OFFLINE</div>
    </div>

    <script>
        const canvas = document.getElementById('pr-canvas');
        const ctx = canvas.getContext('2d');
        const kb = document.getElementById('kb');
        const clock = document.getElementById('clock');
        const assignHint = document.getElementById('assign-hint');
        
        let state = { beat: 0, playing: false, recording: false, metronome: false, notes: [] };
        let assignMode = false;
        let waitingForKey = null;
        
        const startNote = 48; const numNotes = 25; const blackKeys = [1, 3, 6, 8, 10];
        const keyMap = {}; 
        let pcKeys = { 'a':48, 'w':49, 's':50, 'e':51, 'd':52, 'f':53, 't':54, 'g':55, 'y':56, 'h':57, 'u':58, 'j':59, 'k':60 };

        function updateKeyLabels() {
            document.querySelectorAll('.key').forEach(k => k.dataset.key = "");
            for(let k in pcKeys) {
                const el = keyMap[pcKeys[k]];
                if(el) el.dataset.key = k.toUpperCase();
            }
        }

        for (let i = 0; i < numNotes; i++) {
            const n = startNote + i;
            const k = document.createElement('div');
            k.className = 'key' + (blackKeys.includes(i % 12) ? ' black' : '');
            k.dataset.note = n;
            k.onmousedown = (e) => { 
                e.preventDefault();
                if(assignMode) {
                    if(waitingForKey) waitingForKey.classList.remove('waiting');
                    waitingForKey = k;
                    k.classList.add('waiting');
                } else {
                    trigger(n, 0.8); 
                }
            };
            k.onmouseup = () => { if(!assignMode) trigger(n, 0); };
            k.onmouseleave = () => { if(!assignMode && k.classList.contains('active')) trigger(n, 0); };
            keyMap[n] = k; kb.appendChild(k);
        }
        updateKeyLabels();

        function toggleAssignMode() {
            assignMode = !assignMode;
            document.getElementById('assign-btn').classList.toggle('active', assignMode);
            assignHint.style.display = assignMode ? 'block' : 'none';
            if(!assignMode && waitingForKey) {
                waitingForKey.classList.remove('waiting');
                waitingForKey = null;
            }
        }

        function trigger(n, v) {
            if (window.__JUCE__) window.__JUCE__.backend.emitEvent('playNoteEvent', {note: n, velocity: v});
            if (v > 0) keyMap[n]?.classList.add('active'); else keyMap[n]?.classList.remove('active');
        }

        function cmd(c, v) { if (window.__JUCE__) window.__JUCE__.backend.emitEvent('transportEvent', {command: c, value: v}); }
        function toggleRec() { state.recording = !state.recording; cmd('record', state.recording); }
        function toggleMetro() { state.metronome = !state.metronome; cmd('metronome', state.metronome); }
        function updateParams() {
            if (window.__JUCE__) {
                window.__JUCE__.backend.emitEvent("parameterEvent", {name: "osc", value: parseFloat(document.getElementById('osc').value)});
                window.__JUCE__.backend.emitEvent("parameterEvent", {name: "cutoff", value: parseFloat(document.getElementById('cutoff').value)});
                window.__JUCE__.backend.emitEvent("parameterEvent", {name: "res", value: parseFloat(document.getElementById('res').value)});
            }
        }

        window.onkeydown = (e) => { 
            if(assignMode && waitingForKey) {
                const note = parseInt(waitingForKey.dataset.note);
                // Remove old mapping for this key
                for(let k in pcKeys) if(pcKeys[k] === note) delete pcKeys[k];
                pcKeys[e.key.toLowerCase()] = note;
                waitingForKey.classList.remove('waiting');
                waitingForKey = null;
                updateKeyLabels();
                return;
            }
            if(!e.repeat && pcKeys[e.key.toLowerCase()]) trigger(pcKeys[e.key.toLowerCase()], 0.8); 
        };
        window.onkeyup = (e) => { if(pcKeys[e.key.toLowerCase()]) trigger(pcKeys[e.key.toLowerCase()], 0); };

        canvas.onclick = (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left; const y = e.clientY - rect.top;
            const beat = (x / canvas.width) * 16;
            const note = Math.floor(startNote + (1 - y / canvas.height) * numNotes);
            const existing = state.notes.find(n => n.n === note && Math.abs(n.s - beat) < 0.5);
            if (existing) window.__JUCE__.backend.emitEvent('editEvent', {type: 'remove', note: note, beat: existing.s});
            else window.__JUCE__.backend.emitEvent('editEvent', {type: 'add', note: note, beat: Math.floor(beat)});
        };

        window.onUpdate = (msg) => {
            state.beat = msg.beat; state.playing = msg.playing; state.notes = msg.notes;
            const b = Math.floor(state.beat);
            clock.innerText = `${Math.floor(b/4)+1}.${(b%4)+1}.${Math.floor((state.beat%1)*100).toString().padStart(2,'0')}`;
            document.getElementById('play-btn').classList.toggle('active', state.playing);
            document.getElementById('rec-btn').classList.toggle('recording', state.recording);
            document.getElementById('metro-btn').classList.toggle('active', state.metronome);
            draw();
        };

        window.onMidiIn = (msg) => { if(keyMap[msg.note]) msg.velocity > 0 ? keyMap[msg.note].classList.add('active') : keyMap[msg.note].classList.remove('active'); };

        function draw() {
            canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight;
            ctx.fillStyle = '#111'; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.strokeStyle = '#222'; ctx.beginPath();
            for(let i=0; i<=16; i++) { let x = (i/16)*canvas.width; ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); }
            for(let i=0; i<=numNotes; i++) { let y = (i/numNotes)*canvas.height; ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); }
            ctx.stroke();
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--accent').trim();
            state.notes.forEach(n => {
                let x = (n.s / 16) * canvas.width; let w = (n.d / 16) * canvas.width;
                let y = canvas.height - (n.n - startNote + 1) * (canvas.height / numNotes);
                ctx.fillRect(x + 1, y + 1, w - 2, (canvas.height / numNotes) - 2);
            });
            ctx.strokeStyle = '#ff4444'; ctx.lineWidth = 2;
            let px = (state.beat / 16) * canvas.width;
            ctx.beginPath(); ctx.moveTo(px, 0); ctx.lineTo(px, canvas.height); ctx.stroke();
        }

        function checkBridge() {
            if (window.__JUCE__ && window.__JUCE__.backend) {
                document.getElementById('status').innerText = "BRIDGE: ONLINE";
                updateParams();
            } else { setTimeout(checkBridge, 100); }
        }
        checkBridge();
        window.onresize = draw;
    </script>
</body>
</html>